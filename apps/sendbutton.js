import configs from"../model/Config.js";let attempts=0;const maxAttempts=20,delay=100,checkAdapters=async()=>{const ICQQ=Bot.adapter.find(adapter=>adapter.name==="ICQQ"),setupICQQ=adapter=>{adapter.sendMsg=async function(id,pick,msg,...args){const rets={message_id:[],data:[],error:[]};try{const processMessages=async()=>{const processed={buttonMsgs:[],normalMsgs:[],rawMsgs:Array.isArray(msg)?[...msg]:[msg]};for(const item of processed.rawMsgs){const type=item?.type;type==="button"?processed.buttonMsgs.push({type:"button",appid:this.markdown_appid,content:{rows:this.makeButtons(id,pick,item.data)}}):processed.normalMsgs.push(item)}let normalMsgs=await this.makeMsg(id,pick,processed.normalMsgs);return normalMsgs.length===0?{messages:processed.buttonMsgs}:(Array.isArray(normalMsgs)&&normalMsgs.length>0&&Array.isArray(normalMsgs[0])&&(normalMsgs=normalMsgs[0]),{messages:configs.sendbutton?[...normalMsgs,...processed.buttonMsgs]:normalMsgs})},{messages}=await processMessages(),sendMsg=async()=>{for(const i of messages)try{Bot.makeLog("debug",["发送消息",i],id);const ret=await pick.sendMsg(i,...args);Bot.makeLog("debug",["发送消息返回",ret],id),rets.data.push(ret),ret.message_id&&rets.message_id.push(ret.message_id)}catch(err){return Bot.makeLog("error",["发送消息错误",i,err],id),rets.error.push(err),!1}};return await sendMsg()===!1&&(messages=await this.makeMsg(id,pick,[await Bot.makeForwardMsg([{message:messages}])]),await sendMsg()),rets.data.length===1?rets.data[0]:rets}catch(error){return Bot.makeLog("error",["消息发送错误",messages,error],id),rets.error.push(error),rets}}},handleAdapters=()=>{ICQQ&&setupICQQ(ICQQ)};if(ICQQ){handleAdapters();return}if(attempts++,attempts>=maxAttempts){handleAdapters();return}await new Promise(resolve=>setTimeout(resolve,delay)),await checkAdapters()};configs.sendbutton&&checkAdapters()